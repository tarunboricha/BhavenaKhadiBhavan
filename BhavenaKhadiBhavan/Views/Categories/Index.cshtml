@* **ENHANCED: Categories Index View - Create Views/Categories/Index.cshtml** *@
@model List<Category>

@{
    ViewData["Title"] = "Categories";
}

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-primary">
                    <i class="fas fa-tags me-3"></i>Product Categories
                </h2>
                <p class="text-muted mb-0">Organize and manage your product categories</p>
            </div>
            <div>
                <a href="@Url.Action("Create")" class="btn btn-primary btn-lg">
                    <i class="fas fa-plus me-2"></i>Add New Category
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Categories</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Count</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-tags fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Active Categories</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Count(c => c.IsActive)</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Total Products</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Sum(c => c.Products?.Count(p => p.IsActive) ?? 0)</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-cubes fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Empty Categories</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Count(c => c.Products?.Count(p => p.IsActive) == 0)</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Categories Table -->
<div class="card shadow mb-4">
    <div class="card-header py-3 bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-list me-2"></i>All Categories
            </h6>
            <div class="d-flex gap-2">
                <input type="text" id="searchInput" class="form-control form-control-sm"
                       placeholder="Search categories..." style="width: 200px;">
                <select id="statusFilter" class="form-select form-select-sm" style="width: 120px;">
                    <option value="">All Status</option>
                    <option value="active">Active Only</option>
                    <option value="inactive">Inactive Only</option>
                </select>
            </div>
        </div>
    </div>

    <div class="card-body">
        @if (Model.Any())
        {
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="categoriesTable">
                    <thead class="table-light">
                        <tr>
                            <th>Category Name</th>
                            <th>Description</th>
                            <th class="text-center">Products</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Created</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var category in Model.OrderBy(c => c.Name))
                        {
                            <tr data-category-id="@category.Id" class="@(!category.IsActive ? "table-secondary" : "")">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="category-icon me-3">
                                            <i class="fas fa-tag text-primary"></i>
                                        </div>
                                        <div>
                                            <strong>@category.Name</strong>
                                            @if (!category.IsActive)
                                            {
                                                <span class="badge bg-secondary ms-2">Inactive</span>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(category.Description))
                                    {
                                        <div class="description-text">
                                            @(category.Description.Length > 80 ? category.Description.Substring(0, 80) + "..." : category.Description)
                                        </div>
                                        @if (category.Description.Length > 80)
                                        {
                                            <small class="text-muted">
                                                <a href="#" class="toggle-description" data-full-text="@category.Description">Show more</a>
                                            </small>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted"><em>No description provided</em></span>
                                    }
                                </td>
                                <td class="text-center">
                                    @{
                                        var productCount = category.Products?.Count(p => p.IsActive) ?? 0;
                                    }
                                    @if (productCount > 0)
                                    {
                                        <a href="@Url.Action("Details", new { id = category.Id })" class="badge bg-info text-decoration-none">
                                            @productCount Products
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark">0 Products</span>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (category.IsActive)
                                    {
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Active
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-pause me-1"></i>Inactive
                                        </span>
                                    }
                                </td>
                                <td class="text-center">
                                    <div class="small">
                                        @category.CreatedAt.ToString("MMM dd, yyyy")
                                    </div>
                                    <div class="text-muted small">
                                        @category.CreatedAt.ToString("HH:mm")
                                    </div>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <a href="@Url.Action("Details", new { id = category.Id })"
                                           class="btn btn-sm btn-outline-info" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="@Url.Action("Edit", new { id = category.Id })"
                                           class="btn btn-sm btn-outline-warning" title="Edit Category">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="@Url.Action("Delete", new { id = category.Id })"
                                           class="btn btn-sm btn-outline-danger" title="Delete Category">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <i class="fas fa-tags fa-5x text-muted mb-4"></i>
                <h4 class="text-muted">No Categories Found</h4>
                <p class="text-muted mb-4">Start by creating your first product category to organize your inventory.</p>
                <a href="@Url.Action("Create")" class="btn btn-primary btn-lg">
                    <i class="fas fa-plus me-2"></i>Create First Category
                </a>
            </div>
        }
    </div>
</div>

<!-- Quick Actions Card -->
<div class="card shadow">
    <div class="card-header bg-secondary text-white">
        <h6 class="m-0 font-weight-bold">
            <i class="fas fa-bolt me-2"></i>Quick Actions
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="d-grid">
                    <a href="@Url.Action("Create")" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add Category
                    </a>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-grid">
                    <a href="@Url.Action("Create", "Products")" class="btn btn-success">
                        <i class="fas fa-cube me-2"></i>Add Product
                    </a>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-grid">
                    <a href="@Url.Action("Stock", "Reports")" class="btn btn-info">
                        <i class="fas fa-chart-bar me-2"></i>Stock Report
                    </a>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-grid">
                    <a href="@Url.Action("Index", "Products")" class="btn btn-outline-secondary">
                        <i class="fas fa-cubes me-2"></i>Manage Products
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Search functionality
            $('#searchInput').on('keyup', function() {
                var searchTerm = $(this).val().toLowerCase();
                filterTable();
            });

            // Status filter
            $('#statusFilter').on('change', function() {
                filterTable();
            });

            function filterTable() {
                var searchTerm = $('#searchInput').val().toLowerCase();
                var statusFilter = $('#statusFilter').val();

                $('#categoriesTable tbody tr').each(function() {
                    var row = $(this);
                    var categoryName = row.find('td:first strong').text().toLowerCase();
                    var description = row.find('.description-text').text().toLowerCase();
                    var isActive = row.find('.badge:contains("Active")').length > 0;

                    var matchesSearch = categoryName.includes(searchTerm) || description.includes(searchTerm);
                    var matchesStatus = statusFilter === '' ||
                                       (statusFilter === 'active' && isActive) ||
                                       (statusFilter === 'inactive' && !isActive);

                    if (matchesSearch && matchesStatus) {
                        row.show();
                    } else {
                        row.hide();
                    }
                });

                // Update visible count
                var visibleRows = $('#categoriesTable tbody tr:visible').length;
                updateResultsCount(visibleRows);
            }

            function updateResultsCount(count) {
                if (!$('#resultsCount').length) {
                    $('.card-header .text-primary').after('<small id="resultsCount" class="text-muted ms-2"></small>');
                }
                $('#resultsCount').text(`(${count} categories shown)`);
            }

            // Toggle description
            $('.toggle-description').on('click', function(e) {
                e.preventDefault();
                var link = $(this);
                var descriptionDiv = link.parent().prev('.description-text');
                var fullText = link.data('full-text');
                var shortText = fullText.substring(0, 80) + '...';

                if (link.text() === 'Show more') {
                    descriptionDiv.text(fullText);
                    link.text('Show less');
                } else {
                    descriptionDiv.text(shortText);
                    link.text('Show more');
                }
            });

            // Confirm delete
            $('a[href*="/Delete"]').on('click', function(e) {
                var categoryName = $(this).closest('tr').find('td:first strong').text();
                var productCount = $(this).closest('tr').find('.badge:contains("Products")').text();

                var message = `Are you sure you want to delete the category "${categoryName}"?`;
                if (productCount && !productCount.includes('0')) {
                    message += '\n\nNote: This category contains products and will be deactivated instead of deleted.';
                }

                if (!confirm(message)) {
                    e.preventDefault();
                }
            });

            // Initialize results count
            updateResultsCount($('#categoriesTable tbody tr').length);
        });
    </script>

    <style>
        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--khadi-accent);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .description-text {
            line-height: 1.4;
        }

        .toggle-description {
            cursor: pointer;
            text-decoration: none !important;
        }

            .toggle-description:hover {
                text-decoration: underline !important;
            }

        .table-hover tbody tr:hover {
            background-color: rgba(139, 69, 19, 0.05);
        }

        .btn-group .btn {
            margin: 0 1px;
        }

        .card {
            border: none;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(33, 40, 50, 0.15);
        }

        .border-left-primary {
            border-left: 0.25rem solid var(--khadi-primary) !important;
        }

        .border-left-success {
            border-left: 0.25rem solid var(--khadi-success) !important;
        }

        .border-left-info {
            border-left: 0.25rem solid var(--khadi-info) !important;
        }

        .border-left-warning {
            border-left: 0.25rem solid var(--khadi-warning) !important;
        }
    </style>
}