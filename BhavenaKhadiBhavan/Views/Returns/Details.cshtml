@model Return
@{
    ViewData["Title"] = $"Return Details - {Model.ReturnNumber}";
}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>
                <i class="fas fa-undo me-2"></i>
                Return Details - @Model.ReturnNumber
                <span class="badge @(Model.Status switch 
                {
                    "Pending" => "bg-warning text-dark",
                    "Approved" => "bg-info",
                    "Processing" => "bg-primary",
                    "Completed" => "bg-success",
                    "Cancelled" => "bg-secondary",
                    "Rejected" => "bg-danger",
                    _ => "bg-secondary"
                }) ms-2">
                    @Model.Status
                </span>
            </h2>
            <div>
                @if (Model.CanBeProcessed)
                {
                    <a href="@Url.Action("Process", "Returns", new { id = Model.Id })" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>Process Return
                    </a>
                }
                @if (Model.Status == "Pending")
                {
                    <button type="button" class="btn btn-outline-danger" onclick="showCancelModal()">
                        <i class="fas fa-times me-1"></i>Cancel Return
                    </button>
                }
                <a href="@Url.Action("Details", "Sales", new { id = Model.SaleId })" class="btn btn-outline-primary">
                    <i class="fas fa-receipt me-1"></i>Original Sale
                </a>
                <a href="@Url.Action("Index", "Returns")" class="btn btn-outline-secondary">
                    <i class="fas fa-list me-1"></i>All Returns
                </a>
            </div>
        </div>
        <hr>
    </div>
</div>

<div class="row">
    <!-- Return Summary -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Return Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>Return #:</strong>
                    </div>
                    <div class="col-sm-6">
                        @Model.ReturnNumber
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>Date:</strong>
                    </div>
                    <div class="col-sm-6">
                        @Model.ReturnDate.ToString("dd/MM/yyyy HH:mm")
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>Original Sale:</strong>
                    </div>
                    <div class="col-sm-6">
                        <a href="@Url.Action("Details", "Sales", new { id = Model.SaleId })" class="text-decoration-none">
                            @Model.SaleInvoiceNumber
                        </a>
                        <br><small class="text-muted">@Model.Sale?.SaleDate.ToString("dd/MM/yyyy")</small>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>Customer:</strong>
                    </div>
                    <div class="col-sm-6">
                        @Model.CustomerName
                        @if (!string.IsNullOrEmpty(Model.Sale?.CustomerPhone))
                        {
                            <br><small class="text-muted">@Model.Sale.CustomerPhone</small>
                        }
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>Reason:</strong>
                    </div>
                    <div class="col-sm-6">
                        <span class="badge bg-light text-dark">@Model.Reason</span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>Items Count:</strong>
                    </div>
                    <div class="col-sm-6">
                        <span class="badge bg-info">@Model.ItemCount.ToString("0.###")</span>
                    </div>
                </div>
                
                <hr>
                
                <!-- Financial Summary with Discounts -->
                <div class="row mb-2">
                    <div class="col-sm-6">Items Subtotal:</div>
                    <div class="col-sm-6 text-end">₹@Model.SubTotal.ToString("N2")</div>
                </div>
                
                @if (Model.TotalItemDiscounts > 0)
                {
                    <div class="row mb-2">
                        <div class="col-sm-6 text-success">
                            <i class="fas fa-tag me-1"></i>Item Discounts:
                        </div>
                        <div class="col-sm-6 text-end text-success">-₹@Model.TotalItemDiscounts.ToString("N2")</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-6">After Discount:</div>
                        <div class="col-sm-6 text-end">₹@((Model.SubTotal - Model.TotalItemDiscounts).ToString("N2"))</div>
                    </div>
                }
                
                <div class="row mb-2">
                    <div class="col-sm-6">GST Amount:</div>
                    <div class="col-sm-6 text-end">₹@Model.GSTAmount.ToString("N2")</div>
                </div>
                
                <hr>
                
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>Refund Amount:</strong>
                    </div>
                    <div class="col-sm-6 text-end">
                        <h4 class="text-success mb-0">₹@Model.RefundAmount.ToString("N2")</h4>
                    </div>
                </div>
                
                @if (Model.Status == "Completed")
                {
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <strong>Refund Method:</strong>
                        </div>
                        <div class="col-sm-6">
                            <span class="badge bg-success">@Model.RefundMethod</span>
                        </div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(Model.RefundReference))
                    {
                        <div class="row mb-2">
                            <div class="col-sm-6">
                                <strong>Reference:</strong>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted">@Model.RefundReference</small>
                            </div>
                        </div>
                    }
                    
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <strong>Processed:</strong>
                        </div>
                        <div class="col-sm-6">
                            <small>@Model.ProcessedDate?.ToString("dd/MM/yyyy HH:mm")</small>
                            @if (!string.IsNullOrEmpty(Model.ProcessedBy))
                            {
                                <br><small class="text-muted">by @Model.ProcessedBy</small>
                            }
                        </div>
                    </div>
                }
                
                <!-- Discount Summary -->
                @if (Model.TotalItemDiscounts > 0)
                {
                    <div class="mt-3 p-2 bg-light rounded">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Discount Info:</strong><br>
                            Items with discounts: @Model.ReturnItems.Count(i => i.HasDiscount)<br>
                            Effective discount rate: @Model.EffectiveDiscountPercentage.ToString("0.##")%
                        </small>
                    </div>
                }
            </div>
        </div>
    </div>
    
    <!-- Return Items with Individual Discounts -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-box me-2"></i>
                    Returned Items (@Model.ReturnItems.Count)
                    @if (Model.TotalItemDiscounts > 0)
                    {
                        <span class="badge bg-success ms-2">
                            <i class="fas fa-tag me-1"></i>With Discounts
                        </span>
                    }
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th>Returned Qty</th>
                                <th>Unit Price</th>
                                <th>Subtotal</th>
                                <th>Discount Applied</th>
                                <th>GST</th>
                                <th>Refund Amount</th>
                                <th>Condition</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.ReturnItems)
                            {
                                <tr class="@(item.HasDiscount ? "table-success" : "")">
                                    <td>
                                        <strong>@item.ProductName</strong>
                                        @if (item.Product != null)
                                        {
                                            <br>
                                            @if (!string.IsNullOrEmpty(item.Product.Color))
                                            {
                                                <span class="badge bg-light text-dark me-1">@item.Product.Color</span>
                                            }
                                            @if (!string.IsNullOrEmpty(item.Product.Size))
                                            {
                                                <span class="badge bg-light text-dark">@item.Product.Size</span>
                                            }
                                        }
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">@item.ReturnQuantity.ToString("0.###") @(item.UnitOfMeasure ?? "Piece")</span>
                                    </td>
                                    <td>
                                        ₹@item.UnitPrice.ToString("N2")
                                        <br><small class="text-muted">per @(item.UnitOfMeasure ?? "piece")</small>
                                    </td>
                                    <td>
                                        ₹@item.LineSubtotal.ToString("N2")
                                        <br><small class="text-muted">@item.ReturnQuantity.ToString("0.###") × ₹@item.UnitPrice.ToString("N2")</small>
                                    </td>
                                    <td>
                                        @if (item.HasDiscount)
                                        {
                                            <div class="text-success">
                                                <strong>@item.OriginalItemDiscountPercentage.ToString("0.##")%</strong>
                                                <br>
                                                <span class="small">-₹@item.ProportionalDiscountAmount.ToString("N2")</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">No discount</span>
                                        }
                                    </td>
                                    <td>
                                        @item.GSTRate%
                                        <br><small class="text-muted">₹@item.LineGSTAmount.ToString("N2")</small>
                                        @if (item.HasDiscount)
                                        {
                                            <br><small class="text-success">On discounted amount</small>
                                        }
                                    </td>
                                    <td>
                                        <strong>₹@item.RefundLineTotal.ToString("N2")</strong>
                                        @if (item.HasDiscount)
                                        {
                                            <br>
                                            <small class="text-muted">
                                                <del>₹@((item.LineSubtotal + (item.LineSubtotal * item.GSTRate / 100)).ToString("N2"))</del>
                                            </small>
                                            <br>
                                            <small class="text-success">
                                                Saved ₹@((item.LineSubtotal + (item.LineSubtotal * item.GSTRate / 100)) - item.RefundLineTotal).ToString("N2")
                                            </small>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @(item.Condition switch
                                        {
                                            "Good" => "bg-success",
                                            "Minor Wear" => "bg-warning text-dark",
                                            "Damaged" => "bg-danger",
                                            "Defective" => "bg-danger",
                                            "Unusable" => "bg-dark",
                                            _ => "bg-secondary"
                                        })">
                                            @(item.Condition ?? "Good")
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge @(item.Status switch 
                                        {
                                            "Pending" => "bg-warning text-dark",
                                            "Completed" => "bg-success",
                                            "Cancelled" => "bg-secondary",
                                            _ => "bg-info"
                                        })">
                                            @item.Status
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="3">Totals:</th>
                                <th>₹@Model.ReturnItems.Sum(i => i.LineSubtotal).ToString("N2")</th>
                                <th class="text-success">-₹@Model.TotalItemDiscounts.ToString("N2")</th>
                                <th>₹@Model.GSTAmount.ToString("N2")</th>
                                <th>₹@Model.RefundAmount.ToString("N2")</th>
                                <th colspan="2"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- Enhanced Calculation Breakdown -->
                @if (Model.TotalItemDiscounts > 0)
                {
                    <div class="mt-3">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-calculator me-2"></i>Detailed Refund Calculation:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <small>
                                        <strong>Items Subtotal:</strong> ₹@Model.ReturnItems.Sum(i => i.LineSubtotal).ToString("N2")<br>
                                        <strong class="text-success">Proportional Discounts:</strong> -₹@Model.TotalItemDiscounts.ToString("N2")<br>
                                        <strong>After Discounts:</strong> ₹@(Model.SubTotal - Model.TotalItemDiscounts).ToString("N2")<br>
                                        <strong>GST on Discounted Amount:</strong> ₹@Model.GSTAmount.ToString("N2")
                                    </small>
                                </div>
                                <div class="col-md-6">
                                    <small>
                                        <strong class="text-success">Final Refund:</strong> ₹@Model.RefundAmount.ToString("N2")<br>
                                        <strong class="text-success">Customer Savings Maintained:</strong> ₹@Model.TotalItemDiscounts.ToString("N2")<br>
                                        <strong>Items with Discounts:</strong> @Model.ReturnItems.Count(i => i.HasDiscount) of @Model.ReturnItems.Count
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Discount Breakdown by Item -->
                @if (Model.TotalItemDiscounts > 0)
                {
                    <div class="mt-3">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-tags me-2"></i>Discount Breakdown by Item
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    @foreach (var item in Model.ReturnItems.Where(i => i.HasDiscount))
                                    {
                                        <div class="col-md-6 mb-2">
                                            <div class="small">
                                                <strong>@item.ProductName:</strong>
                                                <span class="text-success">
                                                    @item.OriginalItemDiscountPercentage.ToString("0.##")% (-₹@item.ProportionalDiscountAmount.ToString("N2"))
                                                </span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Additional Information -->
<div class="row">
    <!-- Notes and History -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-sticky-note me-2"></i>Notes & History
                </h5>
            </div>
            <div class="card-body">
                @if (!string.IsNullOrWhiteSpace(Model.Notes))
                {
                    <div class="alert alert-light">
                        <h6>Notes:</h6>
                        <p class="mb-0">@Html.Raw(Model.Notes.Replace("\n", "<br>"))</p>
                    </div>
                }
                else
                {
                    <p class="text-muted">No additional notes for this return.</p>
                }
                
                <h6 class="mt-3">Processing History:</h6>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                        <div>
                            <strong>Return Created</strong>
                            <br><small class="text-muted">Status: Pending</small>
                        </div>
                        <small>@Model.ReturnDate.ToString("dd/MM/yyyy HH:mm")</small>
                    </li>
                    
                    @if (Model.ProcessedDate.HasValue)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div>
                                <strong>Return @(Model.Status == "Completed" ? "Processed" : Model.Status)</strong>
                                @if (!string.IsNullOrEmpty(Model.ProcessedBy))
                                {
                                    <br><small class="text-muted">by @Model.ProcessedBy</small>
                                }
                                @if (!string.IsNullOrEmpty(Model.RefundMethod) && Model.Status == "Completed")
                                {
                                    <br><small class="text-muted">Refund via @Model.RefundMethod</small>
                                }
                            </div>
                            <small>@Model.ProcessedDate.Value.ToString("dd/MM/yyyy HH:mm")</small>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Original Sale Information -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-receipt me-2"></i>Original Sale Information
                </h5>
            </div>
            <div class="card-body">
                @if (Model.Sale != null)
                {
                    <div class="row mb-2">
                        <div class="col-sm-4">
                            <strong>Invoice #:</strong>
                        </div>
                        <div class="col-sm-8">
                            <a href="@Url.Action("Details", "Sales", new { id = Model.Sale.Id })" class="text-decoration-none">
                                @Model.Sale.InvoiceNumber
                            </a>
                        </div>
                    </div>
                    
                    <div class="row mb-2">
                        <div class="col-sm-4">
                            <strong>Sale Date:</strong>
                        </div>
                        <div class="col-sm-8">
                            @Model.Sale.SaleDate.ToString("dd/MM/yyyy HH:mm")
                        </div>
                    </div>
                    
                    <div class="row mb-2">
                        <div class="col-sm-4">
                            <strong>Original Total:</strong>
                        </div>
                        <div class="col-sm-8">
                            ₹@Model.Sale.TotalAmount.ToString("N2")
                        </div>
                    </div>
                    
                    @if (Model.Sale.TotalItemDiscounts > 0)
                    {
                        <div class="row mb-2">
                            <div class="col-sm-4">
                                <strong>Original Discounts:</strong>
                            </div>
                            <div class="col-sm-8 text-success">
                                ₹@Model.Sale.TotalItemDiscounts.ToString("N2") (@Model.Sale.EffectiveDiscountPercentage.ToString("0.##")%)
                            </div>
                        </div>
                    }
                    
                    <div class="row mb-2">
                        <div class="col-sm-4">
                            <strong>Payment Method:</strong>
                        </div>
                        <div class="col-sm-8">
                            @Model.Sale.PaymentMethod
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <a href="@Url.Action("Details", "Sales", new { id = Model.Sale.Id })" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye me-1"></i>View Full Sale Details
                        </a>
                        <a href="@Url.Action("PrintInvoice", "Sales", new { id = Model.Sale.Id })" class="btn btn-outline-secondary btn-sm" target="_blank">
                            <i class="fas fa-print me-1"></i>Print Original Invoice
                        </a>
                    </div>
                }
                else
                {
                    <p class="text-muted">Original sale information not available.</p>
                }
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5><i class="fas fa-cogs me-2"></i>Quick Actions</h5>
                <div class="btn-group" role="group">
                    @if (Model.CanBeProcessed)
                    {
                        <a href="@Url.Action("Process", "Returns", new { id = Model.Id })" class="btn btn-success">
                            <i class="fas fa-check me-1"></i>Process Return & Refund
                        </a>
                    }
                    
                    @if (Model.Status == "Pending")
                    {
                        <button type="button" class="btn btn-danger" onclick="showCancelModal()">
                            <i class="fas fa-times me-1"></i>Cancel Return
                        </button>
                    }
                    
                    <a href="@Url.Action("Details", "Sales", new { id = Model.SaleId })" class="btn btn-primary">
                        <i class="fas fa-receipt me-1"></i>View Original Sale
                    </a>
                    
                    @if (Model.Sale?.CustomerPhone != null)
                    {
                        <a href="@Url.Action("Create", "Sales", new { customerPhone = Model.Sale.CustomerPhone })" class="btn btn-info">
                            <i class="fas fa-plus me-1"></i>New Sale (Same Customer)
                        </a>
                    }
                    
                    <a href="@Url.Action("Index", "Returns")" class="btn btn-outline-secondary">
                        <i class="fas fa-list me-1"></i>All Returns
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Return Modal -->
<div class="modal fade" id="cancelReturnModal" tabindex="-1" aria-labelledby="cancelReturnModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelReturnModalLabel">
                    <i class="fas fa-times-circle me-2"></i>Cancel Return
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="@Url.Action("Cancel", "Returns", new { id = Model.Id })" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Are you sure you want to cancel return <strong>@Model.ReturnNumber</strong>?
                        This action will restore the returned quantities to the original sale.
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Cancellation Reason *</label>
                        <textarea class="form-control" name="reason" rows="3" required 
                                  placeholder="Please provide a reason for cancelling this return..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Keep Return</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times me-1"></i>Yes, Cancel Return
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function showCancelModal() {
            $('#cancelReturnModal').modal('show');
        }
        
        $(document).ready(function() {
            // Add hover effects to item rows
            $('tbody tr').hover(
                function() { $(this).addClass('table-active'); },
                function() { $(this).removeClass('table-active'); }
            );
            
            // Add tooltips to badges
            $('[data-bs-toggle="tooltip"]').tooltip();
            
            // Highlight discounted items
            $('.table-success').each(function() {
                $(this).find('td:first').prepend('<i class="fas fa-tag text-success me-1" title="Discounted Item"></i>');
            });
        });
    </script>
}

<style>
    .table-success {
        background-color: rgba(25, 135, 84, 0.1) !important;
        border-left: 3px solid #198754;
    }
    
    .discount-highlight {
        background: linear-gradient(45deg, transparent 30%, rgba(25, 135, 84, 0.1) 30%, rgba(25, 135, 84, 0.1) 70%, transparent 70%);
    }
    
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .badge {
        font-size: 0.75rem;
    }
    
    .text-decoration-none:hover {
        text-decoration: underline !important;
    }
    
    .list-group-item {
        border-left: none;
        border-right: none;
    }
    
    .list-group-item:first-child {
        border-top: none;
    }
    
    .list-group-item:last-child {
        border-bottom: none;
    }
</style>