@model Return
@{
    ViewData["Title"] = "Return Receipt";
    Layout = null;
    var storeSettings = ViewBag.StoreSettings as Dictionary<string, string?> ?? new Dictionary<string, string?>();
}

<!DOCTYPE html>
<html>
<head>
    <title>Return Receipt - @Model.ReturnNumber</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        @@media print {
            .row {
                display: flex !important;
                flex-wrap: wrap !important;
            }

            .col-md-6 {
                flex: 0 0 50% !important;
                max-width: 50% !important;
            }

            .text-md-end {
                text-align: right !important;
            }

            .no-print {
                display: none !important;
            }

            body {
                font-size: 12px;
            }

            .invoice-header {
                border-bottom: 2px solid #000;
            }

            .invoice-footer {
                border-top: 1px solid #000;
                margin-top: 2rem;
            }

            th, td {
                border: 1px solid #000 !important;
                padding: 6px !important;
            }
        }

        @@media screen {
            body {
                background-color: #f8f9fa;
                padding: 2rem;
            }

            .invoice-container {
                background: white;
                max-width: 800px;
                margin: 0 auto;
                padding: 2rem;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
                border-radius: 8px;
            }
        }

        .invoice-header {
            text-align: center;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .store-logo {
            font-size: 2rem;
            font-weight: bold;
            color: #8B4513;
        }

        .store-details {
            color: #666;
            font-size: 0.9rem;
        }

        .invoice-title {
            text-align: center;
            font-size: 1.4rem;
            font-weight: bold;
            margin: 1rem 0;
            color: #333;
        }

        .notice-box {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .invoice-details, .customer-details {
            font-size: 0.9rem;
        }

        .info-box {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .table-invoice th {
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: center;
        }

        .table-invoice td {
            vertical-align: middle;
        }

        .totals-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
        }

        .footer-text {
            text-align: center;
            font-size: 0.8rem;
            color: #666;
            margin-top: 2rem;
            font-style: italic;
        }

        .reason-box {
            background-color: #eaf4ff;
            border: 1px solid #bcdcff;
            padding: 10px;
            border-radius: 5px;
            margin: 1rem 0;
        }

        .discount-info {
            color: #28a745;
            font-size: 0.8rem;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="invoice-container">
        <!-- Header -->
        <div class="invoice-header">
            <div class="store-logo">@(storeSettings.GetValueOrDefault("StoreName", "Khadi Store"))</div>
            <div class="store-details">
                @if (storeSettings.ContainsKey("StoreAddress"))
                {
                    <div>@storeSettings["StoreAddress"]</div>
                }
                <div>
                    @if (storeSettings.ContainsKey("StorePhone"))
                    {
                        <span>Phone: @storeSettings["StorePhone"]</span>
                    }
                    @if (storeSettings.ContainsKey("StoreGST"))
                    {
                        <span class="ms-3">GST: @storeSettings["StoreGST"]</span>
                    }
                    @if (storeSettings.ContainsKey("StoreWebsite"))
                    {
                        <span class="ms-3">@storeSettings["StoreWebsite"]</span>
                    }
                </div>
            </div>
            <div class="invoice-title">RETURN RECEIPT</div>
        </div>

        <!-- Notice -->
        <div class="notice-box">
            ⚠️ This is a return receipt for returned merchandise
        </div>

        <!-- Return & Customer -->
        <div class="row info-box">
            <div class="col-md-6">
                <h6>Return Details</h6>
                <div><strong>No:</strong> @Model.ReturnNumber</div>
                <div><strong>Date:</strong> @Model.ReturnDate.ToString("dd/MM/yyyy")</div>
                <div><strong>Time:</strong> @Model.ReturnDate.ToString("HH:mm")</div>
                <div><strong>Status:</strong> <span class="text-success">@Model.Status</span></div>
            </div>
            <div class="col-md-6">
                <h6>Customer Details</h6>
                <div><strong>Name:</strong> @Model.CustomerName</div>
                @if (!string.IsNullOrEmpty(Model.Sale?.CustomerPhone))
                {
                    <div><strong>Phone:</strong> @Model.Sale.CustomerPhone</div>
                }
                @if (Model.Sale?.Customer?.Address != null)
                {
                    <div><strong>Address:</strong> @Model.Sale.Customer.Address</div>
                }
            </div>
        </div>

        <!-- Original Sale -->
        <div class="info-box">
            <h6 style="color:#0d6efd;">Original Sale Information</h6>
            <div class="d-flex justify-content-between mt-2">
                <div>
                    <strong>Invoice No:</strong> @Model.Sale?.InvoiceNumber<br>
                    <strong>Date:</strong> @Model.Sale?.SaleDate.ToString("dd/MM/yyyy")
                </div>
                <div class="text-end">
                    <strong>Original Amount:</strong> ₹@Model.Sale?.TotalAmount.ToString("N2")<br>
                    <strong>Payment:</strong> @Model.Sale?.PaymentMethod
                </div>
            </div>
        </div>

        <!-- Reason -->
        @if (!string.IsNullOrEmpty(Model.Reason))
        {
            <div class="reason-box">
                <strong>Reason:</strong> @Model.Reason
                @if (!string.IsNullOrEmpty(Model.Notes))
                {
                    <br>
                    <strong>Notes:</strong>

                    @Model.Notes
                }
            </div>
        }

        <!-- Returned Items -->
        <div class="table-responsive">
            <table class="table table-bordered table-invoice">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Description</th>
                        <th>Return Qty</th>
                        <th>Rate</th>
                        <th>GST %</th>
                        <th>Discount</th>
                        <th>Refund</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int itemNumber = 1;
                        decimal totalReturnQty = 0, totalRefundBeforeGST = 0, totalDiscountAmount = 0, totalGSTAmount = 0;
                    }
                    @foreach (var item in Model.ReturnItems)
                    {
                        var itemSubtotal = item.UnitPrice * item.ReturnQuantity;
                        var itemDiscountAmount = item.DiscountAmount;
                        var itemAfterDiscount = itemSubtotal - itemDiscountAmount;
                        var itemGST = item.GSTAmount;
                        var itemRefundTotal = item.LineTotal;

                        totalReturnQty += item.ReturnQuantity;
                        totalRefundBeforeGST += itemAfterDiscount;
                        totalDiscountAmount += itemDiscountAmount;
                        totalGSTAmount += itemGST;

                        var originalSaleItem = item.SaleItem;
                        var discountPercentage = originalSaleItem?.ItemDiscountPercentage ?? 0;

                        <tr>
                            <td class="text-center">@itemNumber</td>
                            <td>
                                <strong>@item.ProductName</strong>
                                @if (item.Product != null && (!string.IsNullOrEmpty(item.Product.Color) || !string.IsNullOrEmpty(item.Product.Size)))
                                {
                                    <br>

                                    <small class="text-muted">
                                        @(string.IsNullOrEmpty(item.Product.Color) ? "" : $"Color: {item.Product.Color}")
                                        @(string.IsNullOrEmpty(item.Product.Size) ? "" : $" | Size: {item.Product.Size}")
                                    </small>
                                }
                                <div class="text-muted">Original Qty: @originalSaleItem?.Quantity.ToString("0.###") @(item.UnitOfMeasure ?? "Pcs")</div>
                            </td>
                            <td class="text-center">@item.ReturnQuantity.ToString("0.###") @(item.UnitOfMeasure ?? "Pcs")</td>
                            <td class="text-center">₹@item.UnitPrice.ToString("N2")</td>
                            <td class="text-center">@item.GSTRate%</td>
                            <td class="text-center">
                                @if (discountPercentage > 0)
                                {
                                    <div class="text-success">@discountPercentage.ToString("0.##")%</div>
                                    <div class="discount-info">-₹@itemDiscountAmount.ToString("N2")</div>
                                }
                                else
                                {

                                    <span>-</span>
                                }
                            </td>
                            <td class="text-end text-danger">₹@itemRefundTotal.ToString("N2")</td>
                        </tr>
                        itemNumber++;
                    }
                </tbody>
                <tfoot>
                    <tr class="table-light">
                        <th colspan="2" class="text-end">Total:</th>
                        <th class="text-center">@totalReturnQty.ToString("0.###")</th>
                        <th></th>
                        <th></th>
                        <th class="text-center">
                            @if (totalDiscountAmount > 0)
                            {
                                <strong class="text-success">-₹@totalDiscountAmount.ToString("N2")</strong>
                            }
                            else
                            {

                                <strong>-</strong>
                            }
                        </th>
                        <th class="text-end text-danger">₹@Model.TotalAmount.ToString("N2")</th>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Totals -->
        <div class="totals-section">
            <div class="d-flex justify-content-between mb-2">
                <span>Return Subtotal:</span>
                <span>₹@Model.SubTotal.ToString("N2")</span>
            </div>
            @if (totalDiscountAmount > 0)
            {
                <div class="d-flex justify-content-between mb-2 text-success">
                    <span>Less: Discounts Refunded:</span>
                    <span>-₹@totalDiscountAmount.ToString("N2")</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Taxable Return Amount:</span>
                    <span>₹@totalRefundBeforeGST.ToString("N2")</span>
                </div>
            }
            @if (totalGSTAmount > 0)
            {
                <div class="d-flex justify-content-between mb-2">
                    <span>GST Refunded:</span>
                    <span>₹@totalGSTAmount.ToString("N2")</span>
                </div>
            }
            <hr>
            <div class="d-flex justify-content-between mb-3">
                <strong style="font-size: 1.1rem;">Total Refund:</strong>
                <strong style="font-size: 1.2rem; color: #dc3545;">₹@Model.TotalAmount.ToString("N2")</strong>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-text">
            Return processed successfully.<br />
            Returned Items: @Model.ReturnItems.Count | Total Qty: @totalReturnQty.ToString("0.###")<br />
            Generated on @DateTime.Now.ToString("dd/MM/yyyy HH:mm")<br />
            <small>This is a computer-generated return receipt</small>
        </div>
    </div>

    <script>
        window.onload = function() {
            setTimeout(function() { window.print(); }, 500);
        };
    </script>
</body>
</html>
